<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KidWatch ğŸ‘§</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; }

  /* Header */
  header { background: #fff; border-bottom: 2px solid #e2e8f0; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
  header h1 { font-size: 1.5rem; font-weight: 700; color: #0f172a; }
  header .meta { font-size: 0.8rem; color: #64748b; text-align: right; }

  /* Tabs */
  nav { background: #fff; border-bottom: 1px solid #e2e8f0; padding: 0 20px; display: flex; gap: 4px; overflow-x: auto; }
  nav button { padding: 12px 18px; border: none; background: none; cursor: pointer; font-size: 0.9rem; font-weight: 500; color: #64748b; border-bottom: 3px solid transparent; transition: all 0.15s; white-space: nowrap; }
  nav button:hover { color: #3b82f6; }
  nav button.active { color: #3b82f6; border-bottom-color: #3b82f6; }

  /* Content */
  main { padding: 20px; max-width: 900px; margin: 0 auto; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Summary cards */
  .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px; }
  .card { background: #fff; border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0; text-align: center; }
  .card .val { font-size: 1.8rem; font-weight: 700; }
  .card .lbl { font-size: 0.75rem; color: #64748b; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
  .card.good .val { color: #22c55e; }
  .card.neutral .val { color: #94a3b8; }
  .card.review .val { color: #f59e0b; }
  .card.flag .val { color: #ef4444; }

  /* Safety badge */
  .badge { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; text-transform: uppercase; }
  .badge.good { background: #dcfce7; color: #15803d; }
  .badge.neutral { background: #f1f5f9; color: #475569; }
  .badge.review { background: #fef3c7; color: #b45309; }
  .badge.flag { background: #fee2e2; color: #dc2626; }

  /* Section header */
  .section-title { font-size: 1rem; font-weight: 600; color: #374151; margin: 20px 0 12px; }

  /* Channel list */
  .channel-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 8px; overflow: hidden; }
  .channel-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; cursor: pointer; transition: background 0.1s; }
  .channel-header:hover { background: #f8fafc; }
  .channel-name { font-weight: 600; flex: 1; font-size: 0.95rem; }
  .channel-count { font-size: 0.85rem; color: #64748b; }
  .channel-chevron { font-size: 0.75rem; color: #94a3b8; transition: transform 0.2s; }
  .channel-item.open .channel-chevron { transform: rotate(90deg); }
  .channel-videos { display: none; border-top: 1px solid #f1f5f9; padding: 8px 16px; background: #fafbfc; }
  .channel-item.open .channel-videos { display: block; }
  .video-entry { padding: 5px 0; font-size: 0.83rem; color: #475569; border-bottom: 1px solid #f1f5f9; }
  .video-entry:last-child { border-bottom: none; }

  /* Override controls */
  .override-row { display: flex; align-items: center; gap: 8px; padding: 8px 0 4px; }
  .override-btn { background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 6px; padding: 4px 10px; font-size: 0.78rem; cursor: pointer; color: #475569; transition: background 0.1s; }
  .override-btn:hover { background: #e2e8f0; }
  .override-select { font-size: 0.8rem; padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 6px; background: #fff; display: none; }
  .override-select.visible { display: inline-block; }

  /* Chart */
  .chart-wrap { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
  canvas { max-height: 300px; }

  /* Table */
  table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; border: 1px solid #e2e8f0; font-size: 0.85rem; }
  th { background: #f8fafc; padding: 10px 14px; text-align: left; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; }
  td { padding: 10px 14px; border-top: 1px solid #f1f5f9; }
  tr:hover td { background: #f8fafc; }

  /* Sort buttons */
  .sort-row { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
  .sort-btn { padding: 6px 14px; border: 1px solid #e2e8f0; border-radius: 20px; background: #fff; font-size: 0.8rem; cursor: pointer; color: #475569; transition: all 0.1s; }
  .sort-btn.active, .sort-btn:hover { background: #3b82f6; color: #fff; border-color: #3b82f6; }

  /* Settings */
  .setting-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
  .setting-item .label { font-size: 0.9rem; }
  .setting-item .val { font-size: 0.85rem; color: #64748b; }
  .btn-danger { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; border-radius: 6px; padding: 4px 12px; font-size: 0.8rem; cursor: pointer; }
  .btn-danger:hover { background: #fca5a5; }
  .btn-primary { background: #3b82f6; color: #fff; border: none; border-radius: 6px; padding: 8px 18px; font-size: 0.85rem; cursor: pointer; margin-top: 8px; }
  .btn-primary:hover { background: #2563eb; }

  /* Empty state */
  .empty { text-align: center; padding: 40px; color: #94a3b8; font-size: 0.9rem; }

  /* Loading */
  .loading { text-align: center; padding: 30px; color: #94a3b8; }

  @media (max-width: 480px) {
    main { padding: 12px; }
    .cards { grid-template-columns: repeat(2, 1fr); }
    header h1 { font-size: 1.2rem; }
  }
</style>
</head>
<body>

<header>
  <h1>KidWatch ğŸ‘§</h1>
  <div class="meta" id="lastUpdated">Loadingâ€¦</div>
</header>

<nav>
  <button class="active" onclick="switchTab('today', this)">ğŸ“… Today</button>
  <button onclick="switchTab('history', this)">ğŸ“ˆ History</button>
  <button onclick="switchTab('channels', this)">ğŸ“º Channels</button>
  <button onclick="switchTab('settings', this)">âš™ï¸ Settings</button>
</nav>

<main>
  <!-- TODAY -->
  <div id="tab-today" class="tab-content active">
    <div class="cards" id="todayCards">
      <div class="loading">Loading today's dataâ€¦</div>
    </div>
    <div class="section-title">Channels Watched Today</div>
    <div id="todayChannels"><div class="loading">Loading channelsâ€¦</div></div>
  </div>

  <!-- HISTORY -->
  <div id="tab-history" class="tab-content">
    <div class="chart-wrap">
      <canvas id="histChart"></canvas>
    </div>
    <div id="histTable"><div class="loading">Loading historyâ€¦</div></div>
  </div>

  <!-- CHANNELS (all-time) -->
  <div id="tab-channels" class="tab-content">
    <div class="sort-row">
      <button class="sort-btn active" onclick="sortChannels('count', this)">Most Watched</button>
      <button class="sort-btn" onclick="sortChannels('review', this)">Highest Review</button>
      <button class="sort-btn" onclick="sortChannels('alpha', this)">Aâ€“Z</button>
    </div>
    <div id="allChannels"><div class="loading">Loading all channelsâ€¦</div></div>
  </div>

  <!-- SETTINGS -->
  <div id="tab-settings" class="tab-content">
    <div class="section-title">Category Overrides</div>
    <div id="settingsOverrides"></div>
    <button class="btn-danger" onclick="clearAllOverrides()" style="margin-top:12px">ğŸ—‘ï¸ Clear All Overrides</button>
    <div class="section-title" style="margin-top:24px">Info</div>
    <div class="setting-item"><span class="label">Last data update</span><span class="val" id="settingsTs">â€”</span></div>
    <button class="btn-primary" onclick="location.reload()">ğŸ”„ Refresh Data</button>
  </div>
</main>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let todayData = null;       // history.json
let allChannels = {};       // aggregated from daily files
let histChartInst = null;
let currentSort = 'count';

const COLORS = {
  good:    '#22c55e',
  neutral: '#94a3b8',
  review:  '#f59e0b',
  flag:    '#ef4444',
};

function getOverrides() {
  return JSON.parse(localStorage.getItem('kidwatch_overrides') || '{}');
}
function setOverride(ch, rating) {
  const o = getOverrides();
  o[ch] = rating;
  localStorage.setItem('kidwatch_overrides', JSON.stringify(o));
}
function clearOverride(ch) {
  const o = getOverrides();
  delete o[ch];
  localStorage.setItem('kidwatch_overrides', JSON.stringify(o));
}
function clearAllOverrides() {
  if (confirm('Clear all channel overrides?')) {
    localStorage.removeItem('kidwatch_overrides');
    location.reload();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Tab switching
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(id, btn) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  btn.classList.add('active');
  if (id === 'history') loadHistory();
  if (id === 'channels') renderAllChannels();
  if (id === 'settings') renderSettings();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtMinutes(mins) {
  if (!mins) return '0m';
  const h = Math.floor(mins / 60), m = Math.round(mins % 60);
  return h ? `${h}h ${m}m` : `${m}m`;
}

function buildBadge(rating) {
  const r = (rating || 'neutral').toLowerCase();
  return `<span class="badge ${r}">${r}</span>`;
}

function buildChannelMap(videos) {
  const overrides = getOverrides();
  const channels = {};
  for (const v of videos) {
    const ch = v.channel || 'Unknown';
    if (!channels[ch]) {
      channels[ch] = { name: ch, videos: [], rating: (v.safety_rating || 'neutral').toLowerCase(), counts: { good: 0, neutral: 0, review: 0, flag: 0 } };
    }
    channels[ch].videos.push(v);
    const r = (v.safety_rating || 'neutral').toLowerCase();
    if (channels[ch].counts[r] !== undefined) channels[ch].counts[r]++;
  }
  // Apply overrides + recompute effective rating
  for (const [ch, rating] of Object.entries(overrides)) {
    if (channels[ch]) channels[ch].rating = rating;
  }
  return channels;
}

// Worst rating wins for display
function worstRating(counts) {
  if (counts.flag > 0) return 'flag';
  if (counts.review > 0) return 'review';
  if (counts.neutral > 0) return 'neutral';
  return 'good';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Channel card renderer (shared)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChannelItem(ch, containerId) {
  const overrides = getOverrides();
  const effectiveRating = overrides[ch.name] || ch.rating || worstRating(ch.counts);
  const videoList = (ch.videos || []).map(v =>
    `<div class="video-entry">â–¸ ${escHtml(v.title || 'Untitled')} <span style="color:#94a3b8">(${v.duration || '?'})</span></div>`
  ).join('');

  const el = document.createElement('div');
  el.className = 'channel-item';
  el.innerHTML = `
    <div class="channel-header" onclick="toggleChannel(this)">
      <span class="channel-name">${escHtml(ch.name)}</span>
      ${buildBadge(effectiveRating)}
      <span class="channel-count">${ch.videos.length} video${ch.videos.length !== 1 ? 's' : ''}</span>
      <span class="channel-chevron">â–¶</span>
    </div>
    <div class="channel-videos">
      ${videoList || '<div class="video-entry" style="color:#94a3b8">No videos</div>'}
      <div class="override-row">
        <button class="override-btn" onclick="showOverride(this, '${escAttr(ch.name)}')">ğŸ·ï¸ Recategorize</button>
        <select class="override-select" onchange="applyOverride(this, '${escAttr(ch.name)}', '${containerId}')">
          <option value="">-- pick --</option>
          <option value="good" ${effectiveRating==='good'?'selected':''}>âœ… Good</option>
          <option value="neutral" ${effectiveRating==='neutral'?'selected':''}>â¬œ Neutral</option>
          <option value="review" ${effectiveRating==='review'?'selected':''}>âš ï¸ Review</option>
          <option value="flag" ${effectiveRating==='flag'?'selected':''}>ğŸš¨ Flag</option>
        </select>
      </div>
    </div>
  `;
  return el;
}

function toggleChannel(header) {
  header.parentElement.classList.toggle('open');
}

function showOverride(btn, chName) {
  const sel = btn.nextElementSibling;
  sel.classList.toggle('visible');
}

function applyOverride(sel, chName, containerId) {
  if (!sel.value) return;
  setOverride(chName, sel.value);
  // Re-render the relevant container
  if (containerId === 'todayChannels') renderToday();
  else if (containerId === 'allChannels') renderAllChannels();
}

function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escAttr(s) { return String(s).replace(/'/g,"\\'"); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TODAY tab
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadToday() {
  try {
    const res = await fetch('data/history.json?_=' + Date.now());
    todayData = await res.json();
  } catch (e) {
    document.getElementById('todayCards').innerHTML = '<div class="empty">Could not load history.json</div>';
    return;
  }
  renderToday();
  // Last updated
  const ts = todayData.generated ? new Date(todayData.generated).toLocaleString() : '?';
  document.getElementById('lastUpdated').textContent = 'Updated: ' + ts;
  document.getElementById('settingsTs').textContent = ts;
}

function renderToday() {
  if (!todayData) return;
  const overrides = getOverrides();
  const videos = todayData.videos || [];
  const channels = buildChannelMap(videos);

  // Recalculate counts with overrides
  const counts = { good: 0, neutral: 0, review: 0, flag: 0 };
  for (const ch of Object.values(channels)) {
    const r = (overrides[ch.name] || ch.rating || 'neutral').toLowerCase();
    for (const v of ch.videos) {
      const vr = overrides[ch.name] ? overrides[ch.name] : (v.safety_rating || 'neutral').toLowerCase();
      if (counts[vr] !== undefined) counts[vr]++;
    }
  }

  // Cards
  document.getElementById('todayCards').innerHTML = `
    <div class="card"><div class="val">${videos.length}</div><div class="lbl">Videos</div></div>
    <div class="card"><div class="val">${fmtMinutes(todayData.total_watch_minutes)}</div><div class="lbl">Watch Time</div></div>
    <div class="card good"><div class="val">${counts.good}</div><div class="lbl">Good</div></div>
    <div class="card neutral"><div class="val">${counts.neutral}</div><div class="lbl">Neutral</div></div>
    <div class="card review"><div class="val">${counts.review}</div><div class="lbl">Review</div></div>
    <div class="card flag"><div class="val">${counts.flag}</div><div class="lbl">Flag</div></div>
  `;

  // Channel list sorted by worst rating then count
  const sorted = Object.values(channels).sort((a, b) => {
    const order = { flag: 0, review: 1, neutral: 2, good: 3 };
    const ra = overrides[a.name] || a.rating || 'neutral';
    const rb = overrides[b.name] || b.rating || 'neutral';
    return (order[ra] - order[rb]) || (b.videos.length - a.videos.length);
  });

  const container = document.getElementById('todayChannels');
  container.innerHTML = '';
  if (sorted.length === 0) {
    container.innerHTML = '<div class="empty">No videos today</div>';
    return;
  }
  for (const ch of sorted) {
    container.appendChild(renderChannelItem(ch, 'todayChannels'));
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HISTORY tab
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let historyLoaded = false;
let dailyData = {}; // date -> parsed JSON

async function loadHistory() {
  if (historyLoaded) return;
  historyLoaded = true;

  let manifest;
  try {
    const res = await fetch('data/daily/manifest.json?_=' + Date.now());
    manifest = await res.json();
  } catch (e) {
    document.getElementById('histTable').innerHTML = '<div class="empty">No history available yet</div>';
    return;
  }

  const dates = (manifest.dates || []).slice(-30); // last 30 days
  if (dates.length === 0) {
    document.getElementById('histTable').innerHTML = '<div class="empty">No daily snapshots yet. Check back tomorrow!</div>';
    return;
  }

  // Load each daily file
  await Promise.all(dates.map(async d => {
    try {
      const r = await fetch(`data/daily/${d}.json?_=` + Date.now());
      dailyData[d] = await r.json();
    } catch (e) { dailyData[d] = null; }
  }));

  renderHistChart(dates);
  renderHistTable(dates);

  // Also aggregate for all-channels tab
  buildAllChannels(dates);
}

function countsByDate(date) {
  const raw = dailyData[date];
  if (!raw) return { good: 0, neutral: 0, review: 0, flag: 0, total: 0, mins: 0 };
  const counts = { good: 0, neutral: 0, review: 0, flag: 0 };
  const overrides = getOverrides();
  const vids = raw.videos || [];
  for (const v of vids) {
    const ch = v.channel || 'Unknown';
    const r = (overrides[ch] || v.safety_rating || 'neutral').toLowerCase();
    if (counts[r] !== undefined) counts[r]++;
  }
  return { ...counts, total: vids.length, mins: raw.total_watch_minutes || 0 };
}

function renderHistChart(dates) {
  const ctx = document.getElementById('histChart').getContext('2d');
  const labels = dates.map(d => d.slice(5)); // MM-DD
  const good = dates.map(d => countsByDate(d).good);
  const neutral = dates.map(d => countsByDate(d).neutral);
  const review = dates.map(d => countsByDate(d).review);
  const flag = dates.map(d => countsByDate(d).flag);

  if (histChartInst) histChartInst.destroy();
  histChartInst = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Good',    data: good,    backgroundColor: COLORS.good,    stack: 'a' },
        { label: 'Neutral', data: neutral, backgroundColor: COLORS.neutral, stack: 'a' },
        { label: 'Review',  data: review,  backgroundColor: COLORS.review,  stack: 'a' },
        { label: 'Flag',    data: flag,    backgroundColor: COLORS.flag,    stack: 'a' },
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' }, title: { display: true, text: 'Videos per Day by Safety Rating' } },
      scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });
}

function renderHistTable(dates) {
  const rows = dates.map(d => {
    const c = countsByDate(d);
    return `<tr>
      <td>${d}</td>
      <td>${c.total}</td>
      <td>${fmtMinutes(c.mins)}</td>
      <td style="color:${COLORS.good}">${c.good}</td>
      <td style="color:${COLORS.neutral}">${c.neutral}</td>
      <td style="color:${COLORS.review}">${c.review}</td>
      <td style="color:${COLORS.flag}">${c.flag}</td>
    </tr>`;
  }).reverse().join('');

  document.getElementById('histTable').innerHTML = `
    <table>
      <thead><tr><th>Date</th><th>Total</th><th>Time</th><th>âœ… Good</th><th>â¬œ Neutral</th><th>âš ï¸ Review</th><th>ğŸš¨ Flag</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CHANNELS tab (all-time)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allChannelsMap = {}; // chName -> {name, videos[], counts{}}

function buildAllChannels(dates) {
  const map = {};
  const overrides = getOverrides();
  for (const d of dates) {
    const raw = dailyData[d];
    if (!raw) continue;
    for (const v of (raw.videos || [])) {
      const ch = v.channel || 'Unknown';
      if (!map[ch]) map[ch] = { name: ch, videos: [], counts: { good: 0, neutral: 0, review: 0, flag: 0 }, rating: (v.safety_rating || 'neutral').toLowerCase() };
      map[ch].videos.push(v);
      const r = (overrides[ch] || v.safety_rating || 'neutral').toLowerCase();
      if (map[ch].counts[r] !== undefined) map[ch].counts[r]++;
    }
  }
  for (const [ch, rating] of Object.entries(overrides)) {
    if (map[ch]) map[ch].rating = rating;
  }
  allChannelsMap = map;
}

function sortChannels(mode, btn) {
  currentSort = mode;
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderAllChannels();
}

function renderAllChannels() {
  // If history not loaded yet, trigger load
  if (!historyLoaded) {
    loadHistory().then(() => renderAllChannels());
    return;
  }

  // If allChannelsMap is empty, build from today's data at minimum
  if (Object.keys(allChannelsMap).length === 0 && todayData) {
    const channels = buildChannelMap(todayData.videos || []);
    for (const [name, ch] of Object.entries(channels)) {
      allChannelsMap[name] = ch;
    }
  }

  const overrides = getOverrides();
  let sorted = Object.values(allChannelsMap);

  if (currentSort === 'count') sorted.sort((a, b) => b.videos.length - a.videos.length);
  else if (currentSort === 'review') sorted.sort((a, b) => (b.counts.review + b.counts.flag) - (a.counts.review + a.counts.flag));
  else sorted.sort((a, b) => a.name.localeCompare(b.name));

  const container = document.getElementById('allChannels');
  container.innerHTML = '';
  if (sorted.length === 0) {
    container.innerHTML = '<div class="empty">No channel data yet</div>';
    return;
  }
  for (const ch of sorted) {
    container.appendChild(renderChannelItem(ch, 'allChannels'));
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SETTINGS tab
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSettings() {
  const overrides = getOverrides();
  const container = document.getElementById('settingsOverrides');
  const entries = Object.entries(overrides);
  if (entries.length === 0) {
    container.innerHTML = '<div class="empty">No overrides set</div>';
    return;
  }
  container.innerHTML = entries.map(([ch, rating]) => `
    <div class="setting-item">
      <span class="label">${escHtml(ch)}</span>
      <span style="display:flex;align-items:center;gap:10px">
        ${buildBadge(rating)}
        <button class="btn-danger" onclick="clearOverride('${escAttr(ch)}'); renderSettings();">âœ•</button>
      </span>
    </div>
  `).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadToday();
</script>
</body>
</html>
