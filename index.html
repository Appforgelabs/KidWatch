<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KidWatch</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; background: #F8FAFC; color: #1E293B; min-height: 100vh; }

  /* Header */
  .header { background: white; border-bottom: 1px solid #E2E8F0; padding: 0 24px; position: sticky; top: 0; z-index: 100; }
  .header-top { display: flex; align-items: center; justify-content: space-between; padding: 14px 0 0; }
  .header-top h1 { font-size: 1.1rem; font-weight: 700; color: #1E293B; }
  .header-top .updated { font-size: 0.75rem; color: #94A3B8; }
  .tabs { display: flex; gap: 0; margin-top: 12px; }
  .tab { padding: 10px 20px; font-size: 0.875rem; font-weight: 500; color: #64748B; cursor: pointer; border-bottom: 3px solid transparent; transition: all .15s; white-space: nowrap; }
  .tab:hover { color: #6366F1; }
  .tab.active { color: #6366F1; border-bottom-color: #6366F1; font-weight: 700; }

  /* Layout */
  .page { display: none; max-width: 960px; margin: 0 auto; padding: 24px 16px; }
  .page.active { display: block; }

  /* Cards */
  .card { background: white; border-radius: 10px; border: 1px solid #E2E8F0; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
  .card + .card, .card + .section, .section + .card, .section + .section { margin-top: 16px; }

  /* Stat row */
  .stat-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
  .stat-card { background: white; border: 1px solid #E2E8F0; border-radius: 10px; padding: 16px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
  .stat-card .value { font-size: 1.75rem; font-weight: 800; color: #1E293B; line-height: 1; }
  .stat-card .label { font-size: 0.7rem; color: #94A3B8; margin-top: 4px; text-transform: uppercase; letter-spacing: .05em; }
  .stat-card.flagged .value { color: #EF4444; }
  .stat-card.safe .value { color: #22C55E; }

  /* Safety bar */
  .safety-bar-wrap { margin-top: 16px; }
  .safety-bar-wrap label { font-size: 0.75rem; color: #64748B; margin-bottom: 6px; display: block; font-weight: 600; text-transform: uppercase; letter-spacing: .05em; }
  .safety-bar { display: flex; height: 10px; border-radius: 99px; overflow: hidden; background: #E2E8F0; }
  .safety-bar .seg-good { background: #22C55E; }
  .safety-bar .seg-neutral { background: #D1D5DB; }
  .safety-bar .seg-review { background: #F59E0B; }
  .safety-bar .seg-flag { background: #EF4444; }
  .safety-legend { display: flex; gap: 12px; margin-top: 8px; flex-wrap: wrap; }
  .safety-legend span { font-size: 0.72rem; color: #64748B; display: flex; align-items: center; gap: 4px; }
  .safety-legend .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

  /* Section title */
  .section-title { font-size: 0.8rem; font-weight: 700; color: #64748B; text-transform: uppercase; letter-spacing: .06em; margin-bottom: 10px; }

  /* Channel rows */
  .channel-list { display: flex; flex-direction: column; gap: 8px; }
  .channel-row { display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: #FAFAFA; border: 1px solid #F1F5F9; border-radius: 8px; }
  .channel-row .badge { font-size: 1.1rem; flex-shrink: 0; }
  .channel-row .ch-info { flex: 1; min-width: 0; }
  .channel-row .ch-name { font-size: 0.875rem; font-weight: 600; color: #1E293B; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .channel-row .ch-flags { font-size: 0.72rem; color: #94A3B8; margin-top: 2px; }
  .channel-row .ch-count { font-size: 0.8rem; font-weight: 700; color: #64748B; flex-shrink: 0; padding: 2px 8px; border-radius: 99px; background: #F1F5F9; }
  .channel-row.flag-row { border-color: #FEE2E2; background: #FFF8F8; }
  .channel-row.review-row { border-color: #FEF3C7; background: #FFFBF0; }

  /* Content tab */
  .filter-bar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .filter-btn { padding: 6px 14px; border-radius: 99px; border: 1.5px solid #E2E8F0; background: white; font-size: 0.8rem; font-weight: 500; color: #64748B; cursor: pointer; transition: all .15s; }
  .filter-btn:hover { border-color: #6366F1; color: #6366F1; }
  .filter-btn.active { background: #6366F1; border-color: #6366F1; color: white; }
  .count-label { font-size: 0.78rem; color: #94A3B8; margin-bottom: 12px; }
  .video-list { display: flex; flex-direction: column; gap: 2px; }
  .video-row { border: 1px solid #F1F5F9; border-radius: 8px; overflow: hidden; background: white; cursor: pointer; }
  .video-summary { display: flex; align-items: center; gap: 10px; padding: 10px 12px; }
  .video-summary:hover { background: #F8FAFF; }
  .video-badge { font-size: 1rem; flex-shrink: 0; width: 22px; text-align: center; }
  .video-title { flex: 1; font-size: 0.82rem; font-weight: 500; color: #1E293B; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .video-meta { font-size: 0.72rem; color: #94A3B8; flex-shrink: 0; text-align: right; }
  .video-detail { display: none; padding: 10px 14px 14px; border-top: 1px solid #F1F5F9; background: #FAFAFE; }
  .video-detail.open { display: block; }
  .video-detail .full-title { font-size: 0.82rem; color: #1E293B; margin-bottom: 8px; font-weight: 600; }
  .video-detail .tag-row { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; }
  .tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; font-weight: 500; }
  .tag.flag { background: #FEE2E2; color: #B91C1C; }
  .tag.positive { background: #DCFCE7; color: #15803D; }
  .video-detail a { font-size: 0.75rem; color: #6366F1; text-decoration: none; }
  .video-detail a:hover { text-decoration: underline; }

  /* Analytics */
  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .chart-card { background: white; border: 1px solid #E2E8F0; border-radius: 10px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
  .chart-card.full { grid-column: 1 / -1; }
  .chart-card h3 { font-size: 0.78rem; font-weight: 700; color: #64748B; text-transform: uppercase; letter-spacing: .05em; margin-bottom: 14px; }
  .chart-card canvas { max-height: 240px; }

  /* History */
  .history-empty { text-align: center; padding: 60px 24px; color: #94A3B8; }
  .history-empty .icon { font-size: 2.5rem; margin-bottom: 12px; }
  .history-empty p { font-size: 0.875rem; }
  .history-list { display: flex; flex-direction: column; gap: 10px; }
  .history-card { background: white; border: 1px solid #E2E8F0; border-radius: 10px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,.06); cursor: pointer; }
  .history-card:hover { border-color: #C7D2FE; }
  .history-card .hc-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .history-card .hc-date { font-weight: 700; font-size: 0.9rem; color: #1E293B; }
  .history-card .hc-meta { font-size: 0.75rem; color: #94A3B8; }
  .history-card .hc-detail { display: none; margin-top: 12px; border-top: 1px solid #F1F5F9; padding-top: 12px; }
  .history-card .hc-detail.open { display: block; }

  /* Responsive */
  @media (max-width: 600px) {
    .stat-row { grid-template-columns: repeat(2, 1fr); }
    .charts-grid { grid-template-columns: 1fr; }
    .chart-card.full { grid-column: 1; }
    .tabs { overflow-x: auto; }
    .tab { padding: 10px 14px; }
  }

  .empty-state { text-align: center; padding: 32px; color: #94A3B8; font-size: 0.875rem; }
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <h1>üëß KidWatch</h1>
    <span class="updated" id="updated-time">Loading...</span>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="switchTab('today', this)">Today</div>
    <div class="tab" onclick="switchTab('content', this)">Content</div>
    <div class="tab" onclick="switchTab('analytics', this)">Analytics</div>
    <div class="tab" onclick="switchTab('history', this)">History</div>
  </div>
</div>

<!-- TODAY -->
<div id="tab-today" class="page active">
  <div class="stat-row" id="stat-row"></div>
  <div class="card" style="margin-top:16px">
    <div class="safety-bar-wrap">
      <label>Safety Breakdown</label>
      <div class="safety-bar" id="safety-bar"></div>
      <div class="safety-legend">
        <span><span class="dot" style="background:#22C55E"></span> Good (<span id="leg-good">0</span>)</span>
        <span><span class="dot" style="background:#D1D5DB"></span> Neutral (<span id="leg-neutral">0</span>)</span>
        <span><span class="dot" style="background:#F59E0B"></span> Review (<span id="leg-review">0</span>)</span>
        <span><span class="dot" style="background:#EF4444"></span> Flagged (<span id="leg-flag">0</span>)</span>
      </div>
    </div>
  </div>
  <div class="card" style="margin-top:16px" id="flagged-section"></div>
  <div class="card" style="margin-top:16px" id="good-section"></div>
</div>

<!-- CONTENT -->
<div id="tab-content" class="page">
  <div class="filter-bar">
    <button class="filter-btn active" onclick="filterContent('all', this)">All</button>
    <button class="filter-btn" onclick="filterContent('good', this)">‚úÖ Good</button>
    <button class="filter-btn" onclick="filterContent('neutral', this)">‚¨ú Neutral</button>
    <button class="filter-btn" onclick="filterContent('review', this)">‚ö†Ô∏è Review</button>
    <button class="filter-btn" onclick="filterContent('flag', this)">üö© Flagged</button>
  </div>
  <div class="count-label" id="content-count"></div>
  <div class="video-list" id="video-list"></div>
</div>

<!-- ANALYTICS -->
<div id="tab-analytics" class="page">
  <div class="charts-grid">
    <div class="chart-card full">
      <h3>Top Channels by Video Count</h3>
      <canvas id="chart-channels"></canvas>
    </div>
    <div class="chart-card">
      <h3>Safety Distribution</h3>
      <canvas id="chart-safety"></canvas>
    </div>
    <div class="chart-card">
      <h3>Safety Score Distribution</h3>
      <canvas id="chart-scores"></canvas>
    </div>
  </div>
</div>

<!-- HISTORY -->
<div id="tab-history" class="page">
  <div id="history-content">
    <div class="history-empty">
      <div class="icon">üìÖ</div>
      <p>Loading history...</p>
    </div>
  </div>
</div>

<script>
let allVideos = [];
let currentFilter = 'all';
let chartsBuilt = false;

// Tab switching
function switchTab(name, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'analytics' && !chartsBuilt) buildCharts();
}

// Format seconds to h:mm
function fmtTime(s) {
  if (!s) return '‚Äî';
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  if (h > 0) return `${h}h ${m}m`;
  return `${m}m`;
}

// Format date
function fmtDate(iso) {
  if (!iso) return '‚Äî';
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
}

// Load main data
fetch('data/history.json')
  .then(r => r.json())
  .then(data => {
    allVideos = data.videos || [];
    const s = data.summary || {};
    const total = data.total_videos || allVideos.length;
    const totalSec = s.total_watch_time_seconds || allVideos.reduce((a,v) => a + (v.duration_seconds||0), 0);

    // Updated time
    document.getElementById('updated-time').textContent = data.generated_at ? 'Updated ' + fmtDate(data.generated_at) : '';

    // Stat cards
    const statsEl = document.getElementById('stat-row');
    statsEl.innerHTML = `
      <div class="stat-card"><div class="value">${total}</div><div class="label">Videos</div></div>
      <div class="stat-card"><div class="value">${fmtTime(totalSec)}</div><div class="label">Watch Time</div></div>
      <div class="stat-card flagged"><div class="value">${(s.flag||0) + (s.review||0)}</div><div class="label">Need Review</div></div>
      <div class="stat-card safe"><div class="value">${s.good||0}</div><div class="label">Safe</div></div>
    `;

    // Safety bar
    const good = s.good||0, neutral = s.neutral||0, review = s.review||0, flag = s.flag||0;
    const tot = good + neutral + review + flag || 1;
    document.getElementById('safety-bar').innerHTML = `
      <div class="seg-good" style="width:${good/tot*100}%"></div>
      <div class="seg-neutral" style="width:${neutral/tot*100}%"></div>
      <div class="seg-review" style="width:${review/tot*100}%"></div>
      <div class="seg-flag" style="width:${flag/tot*100}%"></div>
    `;
    document.getElementById('leg-good').textContent = good;
    document.getElementById('leg-neutral').textContent = neutral;
    document.getElementById('leg-review').textContent = review;
    document.getElementById('leg-flag').textContent = flag;

    // Channel analysis
    const channelMap = {};
    allVideos.forEach(v => {
      if (!channelMap[v.channel]) channelMap[v.channel] = { flag:[], review:[], good:[], neutral:[], flags:new Set() };
      const c = channelMap[v.channel];
      c[v.safety_rating]?.push(v);
      (v.flags||[]).forEach(f => c.flags.add(f));
    });

    // Flagged/review channels
    const flaggedChannels = Object.entries(channelMap)
      .filter(([, c]) => c.flag.length > 0 || c.review.length > 0)
      .sort((a,b) => (b[1].flag.length + b[1].review.length) - (a[1].flag.length + a[1].review.length));

    const flaggedEl = document.getElementById('flagged-section');
    if (flaggedChannels.length === 0) {
      flaggedEl.innerHTML = '<div class="section-title">‚ö†Ô∏è Channels to Review</div><div class="empty-state">Nothing flagged today üéâ</div>';
    } else {
      flaggedEl.innerHTML = '<div class="section-title">‚ö†Ô∏è Channels to Review</div><div class="channel-list" id="flag-list"></div>';
      const fl = document.getElementById('flag-list');
      flaggedChannels.forEach(([name, c]) => {
        const isFlagged = c.flag.length > 0;
        const count = c.flag.length + c.review.length;
        const flagsText = [...c.flags].slice(0,3).join(', ') || 'unusual content';
        const badge = isFlagged ? 'üö©' : '‚ö†Ô∏è';
        const cls = isFlagged ? 'flag-row' : 'review-row';
        fl.innerHTML += `
          <div class="channel-row ${cls}">
            <span class="badge">${badge}</span>
            <div class="ch-info">
              <div class="ch-name">${name}</div>
              <div class="ch-flags">${flagsText}</div>
            </div>
            <span class="ch-count">${count} vid${count>1?'s':''}</span>
          </div>`;
      });
    }

    // Good channels
    const goodChannels = Object.entries(channelMap)
      .filter(([, c]) => c.flag.length === 0 && c.review.length === 0 && c.good.length > 0)
      .sort((a,b) => b[1].good.length - a[1].good.length)
      .slice(0, 5);

    const goodEl = document.getElementById('good-section');
    goodEl.innerHTML = '<div class="section-title">‚úÖ Good Channels Today</div><div class="channel-list" id="good-list"></div>';
    const gl = document.getElementById('good-list');
    if (goodChannels.length === 0) {
      gl.innerHTML = '<div class="empty-state">No all-good channels today</div>';
    } else {
      goodChannels.forEach(([name, c]) => {
        const count = c.good.length + c.neutral.length;
        gl.innerHTML += `
          <div class="channel-row">
            <span class="badge">‚úÖ</span>
            <div class="ch-info"><div class="ch-name">${name}</div></div>
            <span class="ch-count">${count} vid${count>1?'s':''}</span>
          </div>`;
      });
    }

    // Build content list
    buildContentList();
  })
  .catch(e => {
    console.error(e);
    document.getElementById('stat-row').innerHTML = '<div style="color:#EF4444;padding:20px">Failed to load data/history.json</div>';
  });

// Content list
function buildContentList() {
  const filtered = currentFilter === 'all' ? allVideos : allVideos.filter(v => v.safety_rating === currentFilter);
  const countEl = document.getElementById('content-count');
  countEl.textContent = `Showing ${filtered.length} of ${allVideos.length} videos`;
  const listEl = document.getElementById('video-list');
  listEl.innerHTML = '';
  filtered.forEach((v, i) => {
    const title = (v.title||'Unknown').substring(0, 55) + ((v.title||'').length > 55 ? '‚Ä¶' : '');
    const flags = (v.flags||[]).map(f => `<span class="tag flag">${f}</span>`).join('');
    const pos = (v.positive_signals||[]).map(p => `<span class="tag positive">${p}</span>`).join('');
    const div = document.createElement('div');
    div.className = 'video-row';
    div.innerHTML = `
      <div class="video-summary" onclick="toggleVideo(this)">
        <span class="video-badge">${v.safety_badge||'‚¨ú'}</span>
        <span class="video-title">${title}</span>
        <span class="video-meta">${v.channel||''}<br>${v.duration_raw||''}</span>
      </div>
      <div class="video-detail">
        <div class="full-title">${v.title||''}</div>
        ${(flags||pos) ? `<div class="tag-row">${flags}${pos}</div>` : ''}
        <a href="${v.url||'#'}" target="_blank" rel="noopener">Open on YouTube ‚Üó</a>
      </div>`;
    listEl.appendChild(div);
  });
  if (filtered.length === 0) listEl.innerHTML = '<div class="empty-state">No videos in this category</div>';
}

function toggleVideo(el) {
  const detail = el.nextElementSibling;
  detail.classList.toggle('open');
}

function filterContent(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  buildContentList();
}

// Charts
function buildCharts() {
  chartsBuilt = true;
  if (!allVideos.length) return;

  // Channel counts
  const channelCounts = {};
  allVideos.forEach(v => { channelCounts[v.channel] = (channelCounts[v.channel]||0) + 1; });
  const sorted = Object.entries(channelCounts).sort((a,b) => b[1]-a[1]).slice(0,10);
  new Chart(document.getElementById('chart-channels'), {
    type: 'bar',
    data: {
      labels: sorted.map(([c]) => c.length > 22 ? c.substring(0,22)+'‚Ä¶' : c),
      datasets: [{ data: sorted.map(([,n]) => n), backgroundColor: '#6366F1', borderRadius: 4 }]
    },
    options: { indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}},y:{grid:{display:false}}}, responsive:true, maintainAspectRatio:true }
  });

  // Safety doughnut
  const s = { good:0, neutral:0, review:0, flag:0 };
  allVideos.forEach(v => { s[v.safety_rating] = (s[v.safety_rating]||0) + 1; });
  new Chart(document.getElementById('chart-safety'), {
    type: 'doughnut',
    data: {
      labels: ['Good','Neutral','Review','Flagged'],
      datasets: [{ data: [s.good, s.neutral, s.review, s.flag], backgroundColor: ['#22C55E','#D1D5DB','#F59E0B','#EF4444'], borderWidth: 0 }]
    },
    options: { plugins:{legend:{position:'bottom', labels:{boxWidth:12,font:{size:11}}}}, responsive:true, maintainAspectRatio:true }
  });

  // Score histogram
  const buckets = new Array(10).fill(0);
  allVideos.forEach(v => { const b = Math.min(9, Math.floor((v.safety_score||50)/10)); buckets[b]++; });
  new Chart(document.getElementById('chart-scores'), {
    type: 'bar',
    data: {
      labels: ['0-9','10-19','20-29','30-39','40-49','50-59','60-69','70-79','80-89','90-100'],
      datasets: [{ data: buckets, backgroundColor: '#818CF8', borderRadius: 4 }]
    },
    options: { plugins:{legend:{display:false}}, scales:{x:{grid:{display:false},ticks:{font:{size:10}}},y:{grid:{color:'#F1F5F9'}}}, responsive:true, maintainAspectRatio:true }
  });
}

// History
fetch('data/daily/manifest.json')
  .then(r => { if (!r.ok) throw new Error('no manifest'); return r.json(); })
  .then(async manifest => {
    const el = document.getElementById('history-content');
    if (!manifest || manifest.length === 0) {
      el.innerHTML = `<div class="history-empty"><div class="icon">üìÖ</div><p>History builds up over time ‚Äî check back tomorrow.</p></div>`;
      return;
    }
    el.innerHTML = '<div class="history-list" id="history-list"></div>';
    const listEl = document.getElementById('history-list');
    for (const date of manifest.slice().reverse()) {
      try {
        const r = await fetch(`data/daily/${date}.json`);
        const d = await r.json();
        const s = d.summary || {};
        const tot = (s.good||0)+(s.neutral||0)+(s.review||0)+(s.flag||0)||1;
        const card = document.createElement('div');
        card.className = 'history-card';
        const dateLabel = new Date(date).toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
        const wt = fmtTime(s.total_watch_time_seconds || 0);
        card.innerHTML = `
          <div class="hc-top">
            <span class="hc-date">${dateLabel}</span>
            <span class="hc-meta">${d.total_videos||0} videos ¬∑ ${wt}</span>
          </div>
          <div class="safety-bar">
            <div class="seg-good" style="width:${(s.good||0)/tot*100}%"></div>
            <div class="seg-neutral" style="width:${(s.neutral||0)/tot*100}%"></div>
            <div class="seg-review" style="width:${(s.review||0)/tot*100}%"></div>
            <div class="seg-flag" style="width:${(s.flag||0)/tot*100}%"></div>
          </div>
          <div class="hc-detail" id="hd-${date}"></div>`;
        card.querySelector('.hc-top').addEventListener('click', () => toggleHistory(date, d));
        listEl.appendChild(card);
      } catch(e) { /* skip bad dates */ }
    }
  })
  .catch(() => {
    document.getElementById('history-content').innerHTML =
      `<div class="history-empty"><div class="icon">üìÖ</div><p>History builds up over time ‚Äî check back tomorrow.</p></div>`;
  });

function toggleHistory(date, data) {
  const el = document.getElementById('hd-' + date);
  if (el.classList.toggle('open')) {
    const ch = {};
    (data.videos||[]).forEach(v => { ch[v.channel] = (ch[v.channel]||0)+1; });
    const top = Object.entries(ch).sort((a,b)=>b[1]-a[1]).slice(0,8);
    el.innerHTML = '<div class="channel-list">' + top.map(([n,c]) =>
      `<div class="channel-row"><div class="ch-info"><div class="ch-name">${n}</div></div><span class="ch-count">${c}</span></div>`
    ).join('') + '</div>';
  }
}
</script>
</body>
</html>
